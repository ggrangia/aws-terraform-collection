{
  "Comment": "Lambda Deployment",
  "StartAt": "WaitForLambdaUpdate",
  "States": {
    "WaitForLambdaUpdate": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:lambda:getFunction",
      "Parameters": {
        "FunctionName.$": "$.detail.repository-name"
      },
      "ResultSelector": {
        "FunctionName.$": "$.Configuration.FunctionName",
        "LastUpdateStatus.$": "$.Configuration.LastUpdateStatus"
      },
      "ResultPath": "$.Lambda",
      "Next": "CheckUpdateStatus"
    },
    "CheckUpdateStatus": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.Lambda.LastUpdateStatus",
          "StringEquals": "InProgress",
          "Next": "Wait2s"
        },
        {
          "Variable": "$.Lambda.LastUpdateStatus",
          "StringEquals": "Successful",
          "Next": "PublishVersion"
        }
      ],
      "Default": "FailUpdate"
    },
    "Wait2s": {
      "Type": "Wait",
      "Seconds": 2,
      "Next": "WaitForLambdaUpdate"
    },
    "FailUpdate": {
      "Type": "Fail",
      "Error": "UpdateFailed",
      "Cause": "Lambda update not successful"
    },
    "PublishVersion": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:lambda:publishVersion",
      "Parameters": {
        "FunctionName.$": "$.Lambda.FunctionName",
        "Description.$": "$.detail.image-tag"
      },
      "ResultPath": "$.PublishVersion",
      "Next": "GetPrdAlias"
    },
    "GetPrdAlias": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:lambda:getAlias",
      "Parameters": {
        "FunctionName.$": "$.detail.repository-name",
        "Name": "prd"
      },
      "ResultPath": "$.PrdAlias",
      "Next": "CreateTagAlias"
    },
    "CreateTagAlias": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:lambda:createAlias",
      "Parameters": {
        "FunctionName.$": "$.detail.repository-name",
        "Name.$": "$.detail.image-tag",
        "FunctionVersion.$": "$.PublishVersion.Version",
        "Description.$": "$.detail.image-tag"
      },
      "Next": "CreateDeployment"
    },
    "CreateDeployment": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:codedeploy:createDeployment",
      "Parameters": {
        "ApplicationName.$": "$.detail.repository-name",
        "DeploymentGroupName.$": "$.detail.repository-name",
        "DeploymentConfigName": "CodeDeployDefault.LambdaAllAtOnce",
        "Description.$": "States.Format('Updating {} to {}', $.detail.repository-name, $.detail.image-tag)",
        "Revision": {
          "RevisionType": "AppSpecContent",
          "AppSpecContent": {
            "Content.$": "States.JsonToString({\"version\": 0.0, \"Resources\": [{\"myLambdaFunction\": {\"Type\": \"AWS::Lambda::Function\", \"Properties\": {\"Name\": $.detail.repository-name, \"Alias\": \"prd\", \"CurrentVersion\": $.PrdAlias.FunctionVersion, \"TargetVersion\": $.PublishVersion.Version}}}]})"
          }
        }
      },
      "ResultPath": "$.Deployment",
      "Next": "PollDeploymentStatus"
    },
    "PollDeploymentStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:codedeploy:getDeployment",
      "Parameters": {
        "DeploymentId.$": "$.Deployment.deploymentId"
      },
      "ResultPath": "$.DeploymentStatus",
      "Next": "CheckDeploymentStatus"
    },
    "CheckDeploymentStatus": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.DeploymentStatus.deploymentInfo.status",
          "StringEquals": "Succeeded",
          "Next": "Success"
        },
        {
          "Or": [
            {
              "Variable": "$.DeploymentStatus.deploymentInfo.status",
              "StringEquals": "Created"
            },
            {
              "Variable": "$.DeploymentStatus.deploymentInfo.status",
              "StringEquals": "InProgress"
            },
            {
              "Variable": "$.DeploymentStatus.deploymentInfo.status",
              "StringEquals": "Pending"
            },
            {
              "Variable": "$.DeploymentStatus.deploymentInfo.status",
              "StringEquals": "Queued"
            },
            {
              "Variable": "$.DeploymentStatus.deploymentInfo.status",
              "StringEquals": "Ready"
            }
          ],
          "Next": "Wait5s"
        }
      ],
      "Default": "FailDeployment"
    },
    "Wait5s": {
      "Type": "Wait",
      "Seconds": 5,
      "Next": "PollDeploymentStatus"
    },
    "FailDeployment": {
      "Type": "Fail",
      "Error": "DeploymentFailed",
      "Cause": "CodeDeploy deployment did not succeed"
    },
    "Success": {
      "Type": "Succeed"
    }
  }
}